package klustair

import (
	"encoding/json"
	"time"

	"github.com/google/uuid"
	"github.com/klustair/klustair-cli/pkg/trivyscanner"
)

const (
	// Severity
	SeverityCritical = "CRITICAL"
	SeverityHigh     = "HIGH"
	SeverityMedium   = "MEDIUM"
	SeverityLow      = "LOW"
	SeverityUnknown  = "UNKNOWN"

/*
	// TargetType
	TargetTypeImage     = "image"
	TargetTypePod       = "pod"
	TargetTypeContainer = "container"
*/
)

type Vulnerability struct {
	Uid              string            `json:"uid"`
	ReportUid        string            `json:"report_uid"`
	ImageUid         string            `json:"image_uid"`
	TargetUid        string            `json:"target_uid"`
	VulnerabilityID  string            `json:"VulnerabilityID"`
	PkgName          string            `json:"PkgName"`
	Title            string            `json:"Title"`
	Description      string            `json:"Description"`
	InstalledVersion string            `json:"InstalledVersion"`
	FixedVersion     string            `json:"FixedVersion"`
	SeveritySource   string            `json:"SeveritySource"`
	Severity         string            `json:"Severity"`
	SeverityInt      int               `json:"SeverityInt"`
	LastModifiedDate *time.Time        `json:"LastModifiedDate"`
	PublishedDate    *time.Time        `json:"PublishedDate"`
	References       []string          `json:"References"`
	RawCVSS          json.RawMessage   `json:"-"`
	CVSS             trivyscanner.Cvss `json:"CVSS"`
	CweIDs           []string          `json:"CweIDs"`
}

func (v *Vulnerability) SeverityToInt(secerity string) int {
	v.Severity = secerity
	switch secerity {
	case SeverityCritical:
		v.SeverityInt = 0
	case SeverityHigh:
		v.SeverityInt = 1
	case SeverityMedium:
		v.SeverityInt = 2
	case SeverityLow:
		v.SeverityInt = 3
	case SeverityUnknown:
		v.SeverityInt = 4
	default:
		v.SeverityInt = 4
	}
	return v.SeverityInt
}

func NewVulnerability(reportUid string, imageUid string, targetUid string) *Vulnerability {
	v := new(Vulnerability)
	v.Uid = uuid.New().String()
	v.ReportUid = reportUid
	v.ImageUid = imageUid
	v.TargetUid = targetUid
	return v
}
